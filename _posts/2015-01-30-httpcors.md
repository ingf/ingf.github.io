---
layout: post
title: "HTTPè®¿é—®æ§åˆ¶(CORS)"
description: "Android Webview Ajax è·¨åŸŸ HTTP åŒæº cookie"
category: WEB
tags: []
---
# å†™åœ¨å‰é¢

æœ€è¿‘åœ¨å’Œå®¢æˆ·ç«¯åŒå­¦åˆä½œå¼€å‘çš„æ—¶å€™é‡åˆ°äº†å‡ ä¸ªé—®é¢˜ï¼Œåœ¨å®¢æˆ·ç«¯ï¼ˆAndroid Webviewï¼‰é‡Œé¢å†…åµŒäº†ä¸€ä¸ªç½‘é¡µï¼Œå½“ç½‘é¡µå»è¯·æ±‚æ•°æ®æ¥å£çš„æ—¶å€™ï¼ŒAjax å›è°ƒå§‹ç»ˆè¿›å…¥åˆ°äº† error é‡Œé¢ï¼Œä½†æ˜¯ charles æŠ“åŒ…çœ‹æ•°æ®å†…å®¹å’Œæ ¼å¼åˆæ˜¯éƒ½æ˜¯æ­£ç¡®çš„ï¼Œåæ¥å°±åœ¨ Mac chrome é‡Œé¢æ¥è¯·æ±‚çœ‹ä¸‹æƒ…å†µï¼Œè¡¨ç°å’Œå®¢æˆ·ç«¯ä¸€è‡´ï¼Œåœ¨ chrome æ§åˆ¶å°çš„ Network ä¸‹çš„ Response ä¸­æ²¡æœ‰æ˜¾ç¤ºè¿”å›çš„æ•°æ®äºŒæ˜¯æ˜¾ç¤º`This request has no response date available`.åˆ° Console é‡Œé¢ä¸€çœ‹ï¼Œå¤§çº¢è‰²çš„`No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'xxx' is therefore not allowed access.`ğŸ˜„åŸæ¥æ˜¯è·¨åŸŸäº†ã€‚é‚£æˆ‘ä»¬å°±åŠ ä¸Šå…è®¸è·¨åŸŸå¤´å‘—ï¼Œè¿™ä¸ªåŠ è·¨åŸŸå¤´çš„æ­¥éª¤æ¯”æƒ³è±¡ä¸­çš„è¦å¤æ‚ç‚¹ï¼Œå› ä¸º HTTP Method ä¸æ˜¯ç®€å•çš„ GETï¼Œè€Œæ˜¯ POSTï¼Œè¿˜éœ€è¦åŠ ä¸Šå…è®¸è·¨åŸŸçš„ HTTPæ–¹æ³•ã€‚ä»¥ä¸ºåˆ°è¿™é‡Œå°±å¯ä»¥äº†ï¼Œä½†æ˜¯äº‹æƒ…è¿˜æ˜¯æ²¡æœ‰è§£å†³ï¼Œè¿™ä¸ªæ—¶å€™èƒ½çœ‹åˆ°æ•°æ®äº†ï¼Œä½†æ˜¯ç¨‹åºæç¤ºæ²¡æœ‰ç™»å½•ã€‚è¿™æ˜¯å› ä¸ºåœ¨å®¢æˆ·ç«¯é‡Œé¢æ“ä½œï¼Œæ‰€ä»¥ç™»é™†æ˜¯ç”±å®¢æˆ·ç«¯æ¥å®Œæˆçš„ï¼Œç„¶åå°†å‡­è¯ä¿¡æ¯å†™å…¥ cookie ä¸­ï¼Œå¾ˆæ˜æ˜¾è¿™ä¸ªæ—¶å€™ cookie æ²¡æœ‰å¸¦è¿‡å»ã€‚æœ‰æäº†ä¸€ä¸‹å‘ç°è·¨åŸŸ Ajax å¦‚æœéœ€è¦é™„å¸¦å‡­è¯ä¿¡æ¯çš„è¯ï¼Œéœ€è¦åŠ ä¸Šè¿™ä¸ªå‚æ•°`withCredentials = true`ï¼Œè‡³æ­¤é—®é¢˜å·²ç»è§£å†³ã€‚ä¸‹é¢è¯¦ç»†è¯´ä¸€ä¸‹HTTP è·¨åŸŸè®¿é—®ï¼Œäº†è§£äº†ä»¥åï¼Œè¿™äº›é—®é¢˜å°±éƒ½å¾ˆç®€å•äº†ã€‚

# è·¨åŸŸ HTTPè¯·æ±‚

è·¨åŸŸ HTTPè¯·æ±‚æ˜¯æŒ‡è¢«è¯·æ±‚çš„èµ„æºçš„æ‰€åœ¨åŸŸä¸åŒäºå‘èµ·è¯¥è¯·æ±‚çš„èµ„æºçš„æ‰€åœ¨åŸŸã€‚æ¯”å¦‚è¯´ï¼ŒåŸŸå Açš„æŸä¸ª Web åº”ç”¨ç¨‹åºé€šè¿‡ img æ ‡ç­¾å¼•ç”¨äº†åŸŸå B çš„ä¸€å¼ å›¾ç‰‡èµ„æºï¼Œé‚£ä¹ˆåŸŸåA çš„åº”ç”¨ç¨‹åºå°±ä¼šå¯¼è‡´æµè§ˆå™¨å‘èµ·ä¸€ä¸ªè·¨åŸŸ HTTPè¯·æ±‚ï¼Œåœ¨ç°åœ¨çš„å¼€å‘å½“ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨è·¨åŸŸ HTTP è¯·æ±‚åŠ è½½å„ç±»èµ„æºï¼ˆimageã€CSSã€Javascriptå’Œä¸€äº›æ•°æ®èµ„æºï¼‰ã€‚

ä½†æ˜¯å¤„äºå®‰å…¨è€ƒè™‘ï¼Œæµè§ˆå™¨ä¼šé™åˆ¶JavaScript è„šæœ¬å‘èµ·çš„è·¨åŸŸè¯·æ±‚ï¼Œè¡¨ç°æˆ‘ä»¬ä¸Šé¢å·²ç»æåˆ°äº†ï¼Œé€šè¿‡æŠ“åŒ…å·¥å…·æ˜¯èƒ½å¤Ÿçœ‹åˆ°æ•°æ®å†…å®¹çš„ï¼Œä½†æ˜¯æµè§ˆå™¨é‡Œé¢ä¼šæ˜¾ç¤º`This request has no response date available`ã€‚è¿™æ˜¯å› ä¸º XMLHttpRequestå¯¹è±¡å‘èµ·çš„ HTTP è¯·æ±‚å¿…é¡»éµå®ˆ[åŒæºç­–ç•¥](https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy)ï¼Œä¹Ÿå°±æ˜¯è¯´ WEB åº”ç”¨ç¨‹åºåªèƒ½é€šè¿‡ XMLHttpRequestå¯¹è±¡å‘èµ·åŒåŸŸè¯·æ±‚ï¼Œå„¿ä¸èƒ½å‘èµ·è·¨åŸŸ HTTP è¯·æ±‚ã€‚ä½†æ˜¯è¿™ç§éœ€æ±‚æ˜¯å­˜åœ¨çš„ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šéœ€è¦å»åŠ è½½è·¨åŸŸèµ„æºã€‚å› æ­¤ï¼ŒW3C çš„ Web åº”ç”¨å·¥ä½œç»„( [Web Applications Working Group](http://www.w3.org/2008/webapps/) )æ¨èäº†ä¸€ç§æ–°çš„æœºåˆ¶ï¼Œå³è·¨æºèµ„æºå…±äº«ï¼ˆ[Cross-Origin Resource Sharing](http://www.w3.org/TR/cors/) (CORS)ï¼‰ï¼Œè¿™ç§æœºåˆ¶è®©Webåº”ç”¨æœåŠ¡å™¨èƒ½æ”¯æŒè·¨ç«™è®¿é—®æ§åˆ¶ï¼Œä»è€Œä½¿å¾—å®‰å…¨åœ°è¿›è¡Œè·¨ç«™æ•°æ®ä¼ è¾“æˆä¸ºå¯èƒ½ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªè§„èŒƒæ˜¯é’ˆå¯¹APIå®¹å™¨çš„ã€‚æ¯”å¦‚è¯´ï¼Œè¦ä½¿å¾— XMLHttpRequest åœ¨ç°ä»£æµè§ˆå™¨ä¸­å¯ä»¥å‘èµ·è·¨åŸŸè¯·æ±‚ã€‚æµè§ˆå™¨å¿…é¡»èƒ½æ”¯æŒè·¨æºå…±äº«å¸¦æ¥çš„æ–°çš„ç»„ä»¶ï¼ŒåŒ…æ‹¬è¯·æ±‚å¤´å’Œç­–ç•¥æ‰§è¡Œã€‚

# æ¦‚è¿°

è·¨æºèµ„æºå…±äº«æ ‡å‡†é€šè¿‡æ–°å¢ä¸€ç³»åˆ— HTTP å¤´ï¼Œè®©æœåŠ¡å™¨èƒ½å£°æ˜é‚£äº›æ¥æºå¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®è¯¥æœåŠ¡å™¨ä¸Šçš„èµ„æºã€‚å¦å¤–ï¼Œå¯¹é‚£äº›ä¼šå¯¹æœåŠ¡å™¨æ•°æ®é€ æˆç ´åæ€§å½±å“çš„ HTTP è¯·æ±‚æ–¹æ³•ï¼ˆç‰¹åˆ«æ˜¯ GET ä»¥å¤–çš„ HTTP æ–¹æ³•ï¼Œæˆ–è€…æ­é…æŸäº›MIMEç±»å‹çš„POSTè¯·æ±‚ï¼‰ï¼Œæ ‡å‡†è¦æ±‚æµè§ˆå™¨å¿…é¡»å…ˆä»¥ OPTIONS è¯·æ±‚æ–¹å¼å‘é€ä¸€ä¸ªé¢„è¯·æ±‚(preflight request)ï¼Œä»è€Œè·çŸ¥æœåŠ¡å™¨ç«¯å¯¹è·¨æºè¯·æ±‚æ‰€æ”¯æŒ HTTP æ–¹æ³•ã€‚åœ¨ç¡®è®¤æœåŠ¡å™¨å…è®¸è¯¥è·¨æºè¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œä»¥å®é™…çš„ HTTP è¯·æ±‚æ–¹æ³•å‘é€é‚£ä¸ªçœŸæ­£çš„è¯·æ±‚ã€‚æœåŠ¡å™¨ç«¯ä¹Ÿå¯ä»¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ˜¯ä¸æ˜¯éœ€è¦éšåŒè¯·æ±‚ä¸€èµ·å‘é€ä¿¡ç”¨ä¿¡æ¯ï¼ˆåŒ…æ‹¬ Cookies å’Œ HTTP è®¤è¯ç›¸å…³æ•°æ®ï¼‰ã€‚

# ä¸€äº›è®¿é—®æ§åˆ¶åœºæ™¯

åœ¨æ­¤ï¼Œæˆ‘ä»¬ä¼šç”¨ä¸‰ä¸ªåœºæ™¯æ¥è§£é‡Šè·¨æºå…±äº«æ˜¯æ€ä¹ˆè¿è¡Œçš„ã€‚å…¶ä¸­ï¼Œæ‰€æœ‰çš„è·¨ç«™è¯·æ±‚éƒ½æ˜¯é€šè¿‡ XMLHttpRequest å¯¹è±¡å‘èµ·ï¼Œè¿™é‡Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨ jQueryã€‚

## ç®€å•è¯·æ±‚

æ‰€è°“çš„ç®€å•ï¼Œæ˜¯æŒ‡ï¼š

- åªä½¿ç”¨ GET, HEAD æˆ–è€… POST è¯·æ±‚æ–¹æ³•ã€‚å¦‚æœä½¿ç”¨ POST å‘æœåŠ¡å™¨ç«¯ä¼ é€æ•°æ®ï¼Œåˆ™æ•°æ®ç±»å‹(Content-Type)åªèƒ½æ˜¯ application/x-www-form-urlencoded, multipart/form-data æˆ– text/plainä¸­çš„ä¸€ç§ã€‚
- ä¸ä¼šä½¿ç”¨è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆç±»ä¼¼äº X-Modified è¿™ç§ï¼‰ã€‚

æ¯”å¦‚è¯´http://127.0.0.1:8088 çš„ Web åº”ç”¨æƒ³è¦è¯·æ±‚ xxx çš„èµ„æº

    $.ajax({
        url: 'http://xxx.com/res',
        success: successCallback,
        error: errorCallback
    });

é‚£ä¹ˆè¿™ä¸ªè¯·æ±‚çš„è¯·æ±‚å’Œå“åº”å¦‚ä¸‹ï¼š

    Remote Address:220.181.57.217:80
    Request URL:http://xxx.com/res
    Request Method:GET
    Status Code:200 OK

    Request Headersview source
    Accept:*/*
    Accept-Encoding:gzip, deflate, sdch
    Accept-Language:zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4,ja;q=0.2,ru;q=0.2
    Cache-Control:no-cache
    Connection:keep-alive
    DNT:1
    Host:api.mocar.cn
    Origin:http://127.0.0.1:8088
    Pragma:no-cache
    User-Agent:Mozilla/5.0 (iPhone; CPU iPhone OS 7_0 like Mac OS X; en-us) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11A465 Safari/9537.53

    Response Headersview source
    Access-Control-Allow-Origin:*
    Access-Control-Expose-Headers:Location
    Connection:close
    Content-Encoding:gzip
    Content-Type:application/json
    Date:Fri, 30 Jan 2015 15:43:03 GMT
    Server:Apache-Coyote/1.1
    Transfer-Encoding:chunked
    Vary:Accept-Encoding

è¯·æ±‚å¤´ä¸­è®¾ç½®äº† `Origin: http://127.0.0.1:8088`ï¼Œè¡¨æ˜åœ¨è¯·æ±‚æ¥è‡ª http://127.0.0.1:8088
å“åº”å¤´ä¸­è®¾ç½®äº†`Access-Control-Allow-Origin: *`ï¼Œè¿™è¡¨æ˜æœåŠ¡å™¨æ¥å—æ¥è‡ªä»»ä½•ç«™ç‚¹çš„è·¨ç«™è¯·æ±‚

å¦‚æœæœåŠ¡å™¨ç«¯ä»…å…è®¸æ¥è‡ª http://127.0.0.1:8088 çš„è·¨ç«™è¯·æ±‚ï¼Œå®ƒå¯ä»¥è¿”å›ï¼š`Access-Control-Allow-Origin: http://127.0.0.1:8088`ã€‚
å¦‚ä¸Šï¼Œé€šè¿‡ä½¿ç”¨ Origin å’Œ Access-Control-Allow-Origin å°±å¯ä»¥å®Œæˆæœ€ç®€å•çš„è·¨ç«™è¯·æ±‚ã€‚ä¸è¿‡ Access-Control-Allow-Origin éœ€è¦ä¸º * æˆ–è€…åŒ…å«ç”± Origin æŒ‡æ˜çš„ç«™ç‚¹ã€‚

# é¢„è¯·æ±‚

ä¸åŒäºä¸Šé¢è®¨è®ºçš„ç®€å•è¯·æ±‚ï¼Œâ€œé¢„è¯·æ±‚â€è¦æ±‚å¿…é¡»å…ˆå‘é€ä¸€ä¸ª OPTIONS è¯·æ±‚ç»™ç›®çš„ç«™ç‚¹ï¼Œæ¥æŸ¥æ˜è¿™ä¸ªè·¨ç«™è¯·æ±‚å¯¹äºç›®çš„ç«™ç‚¹æ˜¯ä¸æ˜¯å®‰å…¨å¯æ¥å—çš„ã€‚è¿™æ ·åšï¼Œæ˜¯å› ä¸ºè·¨ç«™è¯·æ±‚å¯èƒ½ä¼šå¯¹ç›®çš„ç«™ç‚¹çš„æ•°æ®é€ æˆç ´åã€‚ å½“è¯·æ±‚å…·å¤‡ä»¥ä¸‹æ¡ä»¶ï¼Œå°±ä¼šè¢«å½“æˆé¢„è¯·æ±‚å¤„ç†ï¼š

- è¯·æ±‚ä»¥ GET, HEAD æˆ–è€… POST ä»¥å¤–çš„æ–¹æ³•å‘èµ·è¯·æ±‚ã€‚æˆ–è€…ï¼Œä½¿ç”¨ POSTï¼Œä½†è¯·æ±‚æ•°æ®ä¸º application/x-www-form-urlencoded, multipart/form-data æˆ–è€… text/plain ä»¥å¤–çš„æ•°æ®ç±»å‹ã€‚æ¯”å¦‚è¯´ï¼Œç”¨ POST å‘é€æ•°æ®ç±»å‹ä¸º application/xml æˆ–è€… text/xml çš„ XML æ•°æ®çš„è¯·æ±‚ã€‚
- ä½¿ç”¨è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆæ¯”å¦‚æ·»åŠ è¯¸å¦‚ X-PINGOTHERï¼‰

æ¯”å¦‚è¯´http://127.0.0.1:8088 çš„ Web åº”ç”¨æƒ³è¦è¯·æ±‚ xxx çš„èµ„æº

    $.ajax({
        method: 'POST',
        headers: {'Access-Token': accessToken},
        url: 'http://xxx.com/res',
        data: data,
        success: successCallback,
        error: errorCallback
    });

é‚£ä¹ˆè¿™ä¸ªè¯·æ±‚çš„è¯·æ±‚å’Œå“åº”å¦‚ä¸‹

- é¢„è¯·æ±‚

        Remote Address:220.181.57.217:80
        Request URL:http://xxx.com/res
        Request Method:OPTIONS
        Status Code:200 OK

        Request Headersview source
        Accept:*/*
        Accept-Encoding:gzip, deflate, sdch
        Accept-Language:zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4,ja;q=0.2,ru;q=0.2
        Access-Control-Request-Headers:access-token
        Access-Control-Request-Method:POST
        Cache-Control:no-cache
        Connection:keep-alive
        DNT:1
        Host:api.mocar.cn
        Origin:http://127.0.0.1:8088
        Pragma:no-cache
        User-Agent:Mozilla/5.0 (iPhone; CPU iPhone OS 7_0 like Mac OS X; en-us) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11A465 Safari/9537.53

        Response Headersview source
        Access-Control-Allow-Headers:access-token
        Access-Control-Allow-Methods:POST
        Access-Control-Allow-Origin:http://127.0.0.1:8088
        Access-Control-Max-Age:1728000
        Connection:close
        Content-Encoding:gzip
        Content-Length:20
        Content-Type:text/plain; charset=UTF-8
        Date:Fri, 30 Jan 2015 15:43:25 GMT
        Server:Apache-Coyote/1.1
        Vary:Accept-Encoding

- çœŸå®è¯·æ±‚

        Remote Address:220.181.57.217:80
        Request URL:http://xxx.com/res
        Request Method:POST
        Status Code:201 Created
        
        Request Headersview source
        Accept:*/*
        Accept-Encoding:gzip, deflate
        Accept-Language:zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4,ja;q=0.2,ru;q=0.2
        Access-Token:cfcf67b8134bba4eb375fa745baec379
        Cache-Control:no-cache
        Connection:keep-alive
        Content-Length:273
        Content-Type:application/json
        DNT:1
        Host:api.mocar.cn
        Origin:http://127.0.0.1:8088
        Pragma:no-cache
        User-Agent:Mozilla/5.0 (iPhone; CPU iPhone OS 7_0 like Mac OS X; en-us) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11A465 Safari/9537.53

        Request Payloadview source
        Object

        Response Headersview source
        Access-Control-Allow-Credentials:true
        Access-Control-Allow-Origin:http://127.0.0.1:8088
        Access-Control-Expose-Headers:Location
        Connection:close
        Content-Encoding:gzip
        Content-Length:20
        Content-Type:text/plain; charset=UTF-8
        Date:Fri, 30 Jan 2015 15:43:25 GMT
        Location:http://api.mocar.cn/vrs/users/me/orders/5219
        Server:Apache-Coyote/1.1
        Vary:Accept-Encoding

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª OPTIONS å‘é€äº†ä¸€ä¸ªâ€œé¢„è¯·æ±‚â€ã€‚æµè§ˆå™¨æ ¹æ®è¯·æ±‚å‚æ•°ï¼Œå†³å®šéœ€è¦å‘é€ä¸€ä¸ªâ€œé¢„è¯·æ±‚â€ï¼Œæ¥æ¢æ˜æœåŠ¡å™¨ç«¯æ˜¯å¦æ¥å—åç»­çœŸæ­£çš„è¯·æ±‚ã€‚ OPTIONS æ˜¯ HTTP/1.1 é‡Œçš„æ–¹æ³•ï¼Œç”¨æ¥è·å–æ›´å¤šæœåŠ¡å™¨ç«¯çš„ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ªä¸åº”è¯¥å¯¹æœåŠ¡å™¨æ•°æ®é€ æˆå½±å“çš„æ–¹æ³•ã€‚ éšåŒ OPTIONS è¯·æ±‚ï¼Œä»¥ä¸‹ä¸¤ä¸ªè¯·æ±‚å¤´ä¸€èµ·è¢«å‘é€ï¼š

    Access-Control-Request-Headers:access-token
    Access-Control-Request-Method:POST

è¯·æ±‚å¤´Access-Control-Request-Methodå¯ä»¥æé†’æœåŠ¡å™¨è·¨ç«™è¯·æ±‚å°†ä½¿ç”¨POSTæ–¹æ³•ï¼Œè€Œè¯·æ±‚å¤´Access-Control-Request-Headersåˆ™å‘ŠçŸ¥æœåŠ¡å™¨è¯¥è·¨ç«™è¯·æ±‚å°†æºå¸¦ä¸€ä¸ªè‡ªå®šä¹‰è¯·æ±‚å¤´access-tokenã€‚è¿™æ ·ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥å†³å®šï¼Œåœ¨å½“å‰æƒ…å†µä¸‹ï¼Œæ˜¯å¦æ¥å—è¯¥è·¨ç«™è¯·æ±‚è®¿é—®ã€‚
ç„¶åæ ¹æ®æœåŠ¡å™¨çš„å“åº”ã€‚è¯¥å“åº”è¡¨æ˜ï¼ŒæœåŠ¡å™¨æ¥å—äº†å®¢æœç«¯çš„è·¨ç«™è¯·æ±‚ã€‚å…·ä½“æ˜¯è¿™å‡ è¡Œï¼š

    Access-Control-Allow-Headers:access-token
    Access-Control-Allow-Methods:POST
    Access-Control-Allow-Origin:http://127.0.0.1:8088
    Access-Control-Max-Age:1728000

å“åº”å¤´Access-Control-Allow-Methodsè¡¨æ˜æœåŠ¡å™¨å¯ä»¥æ¥å—POSTçš„è¯·æ±‚æ–¹æ³•ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸ªå“åº”å¤´ç±»ä¼¼äºHTTP/1.1 Allow: response headerï¼Œä½†ä»…é™äºè®¿é—®æ§åˆ¶çš„åœºæ™¯ä¸‹ã€‚è€Œå“åº”å¤´Access-Control-Allow-Headersåˆ™è¡¨ç¤ºæœåŠ¡å™¨æ¥å—è‡ªå®šä¹‰è¯·æ±‚å¤´access-tokenã€‚å°±åƒAccess-Control-Allow-Methodsä¸€æ ·ï¼ŒAccess-Control-Allow-Headerså…è®¸ä»¥é€—å·åˆ†éš”ï¼Œä¼ é€’ä¸€ä¸ªå¯æ¥å—çš„è‡ªå®šä¹‰è¯·æ±‚å¤´åˆ—è¡¨ã€‚æœ€åï¼Œå“åº”å¤´Access-Control-Max-Ageå‘Šè¯‰æµè§ˆå™¨ï¼Œæœ¬æ¬¡â€œé¢„è¯·æ±‚â€çš„å“åº”ç»“æœæœ‰æ•ˆæ—¶é—´æ˜¯å¤šä¹…ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­é‡Œï¼Œ1728000ç§’ä»£è¡¨ç€20å¤©å†…ï¼Œæµè§ˆå™¨åœ¨å¤„ç†é’ˆå¯¹è¯¥æœåŠ¡å™¨çš„è·¨ç«™è¯·æ±‚ï¼Œéƒ½å¯ä»¥æ— éœ€å†å‘é€â€œé¢„è¯·æ±‚â€ï¼Œåªéœ€æ ¹æ®æœ¬æ¬¡ç»“æœè¿›è¡Œåˆ¤æ–­å¤„ç†ã€‚

# é™„å¸¦å‡­è¯ä¿¡æ¯çš„è¯·æ±‚

XMLHttpRequestå’Œè®¿é—®æ§åˆ¶åŠŸèƒ½ï¼Œæœ€æœ‰è¶£çš„ç‰¹æ€§å°±æ˜¯ï¼Œå‘é€å‡­è¯è¯·æ±‚ï¼ˆHTTP Cookieså’ŒéªŒè¯ä¿¡æ¯ï¼‰çš„åŠŸèƒ½ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œå¯¹äºè·¨ç«™è¯·æ±‚ï¼Œæµè§ˆå™¨æ˜¯ä¸ä¼šå‘é€å‡­è¯ä¿¡æ¯çš„ã€‚ä½†å¦‚æœå°†XMLHttpRequestçš„ä¸€ä¸ªç‰¹æ®Šæ ‡å¿—ä½è®¾ç½®ä¸ºtrueï¼Œæµè§ˆå™¨å°±å°†å…è®¸è¯¥è¯·æ±‚çš„å‘é€ã€‚

æ¯”å¦‚è¯´http://127.0.0.1:8088 çš„ Web åº”ç”¨æƒ³è¦è¯·æ±‚ xxxxx çš„èµ„æºï¼Œå¹¶è®¾ç½®äº†ä¸€ä¸ªCookieså€¼ã€‚è„šæ­¥ä»£ç å¦‚ä¸‹ï¼š

    $.ajax({
        url: 'http://xxx.com/res',
        data: data,
        xhrFields: {withCredentials: true},
        success: successCallback,
        error: errorCallback
    });

å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢å°†XMLHttpRequestçš„withCredentialsæ ‡å¿—è®¾ç½®ä¸ºtrueï¼Œä»è€Œä½¿å¾—Cookieså¯ä»¥éšç€è¯·æ±‚å‘é€ã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªç®€å•çš„GETè¯·æ±‚ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¸ä¼šå‘é€ä¸€ä¸ªâ€œé¢„è¯·æ±‚â€ã€‚ä½†æ˜¯ï¼Œå¦‚æœæœåŠ¡å™¨ç«¯çš„å“åº”ä¸­ï¼Œå¦‚æœæ²¡æœ‰è¿”å›Access-Control-Allow-Credentials: trueçš„å“åº”å¤´ï¼Œé‚£ä¹ˆæµè§ˆå™¨å°†ä¸ä¼šæŠŠå“åº”ç»“æœä¼ é€’ç»™å‘å‡ºè¯·æ±‚çš„è„šæ­¥ç¨‹åºï¼Œä»¥ä¿è¯ä¿¡æ¯çš„å®‰å…¨ã€‚

é‚£ä¹ˆè¿™ä¸ªè¯·æ±‚çš„è¯·æ±‚å’Œå“åº”å¦‚ä¸‹ï¼š

    Remote Address:220.181.57.217:80
    Request URL:http://xxx.com/res
    Request Method:POST
    Status Code:200 OK
    
    Request Headersview source
    Accept:*/*
    Accept-Encoding:gzip, deflate
    Accept-Language:zh-CN,zh;q=0.8,en-US;q=0.6,en;q=0.4,ja;q=0.2,ru;q=0.2
    Cache-Control:no-cache
    Content-Length:28
    Content-Type:application/x-www-form-urlencoded
    Cookie:uid=19283023
    DNT:1
    Host:xxx.com
    Origin:http://127.0.0.1:8088
    Pragma:no-cache
    Proxy-Connection:keep-alive
    User-Agent:Mozilla/5.0 (iPhone; CPU iPhone OS 7_0 like Mac OS X; en-us) AppleWebKit/537.51.1 (KHTML, like Gecko) Version/7.0 Mobile/11A465 Safari/9537.53
    
    Response Headersview source
    Access-Control-Allow-Credentials:true
    Access-Control-Allow-Origin:http://127.0.0.1:8088
    Cache-Control:no-cache
    Content-Type:application/json; charset=UTF-8
    Date:Fri, 30 Jan 2015 13:43:51 GMT
    Expires:0
    Proxy-Connection:Keep-alive
    Server:nginx
    Transfer-Encoding:chunked
    X-Whom:qmmwx_0

å°½ç®¡æˆ‘ä»¬åœ¨è¿™é‡ŒæŒ‡å®šäº†http://xxx.com/resçš„ cookieï¼Œä½†æ˜¯å¦‚æœå“åº”ä¸­æ²¡æœ‰è¿™ä¸ªå¤´`Access-Control-Allow-Credentials: true`çš„è¯ï¼Œè¿™ä¸ªå“åº”å°†ä¼šå‘—æµè§ˆå™¨å¿½ç•¥æ‰ã€‚è¿˜æœ‰ä¸€ä¸ªä¸»è¦æ³¨æ„çš„åœ°æ–¹å°±æ˜¯å¿…é¡»æŒ‡å®šæ˜ç¡®çš„Access-Control-Allow-Originï¼Œä¸èƒ½ä½¿ç”¨é€šé…ç¬¦`*`ã€‚

{% include JB/setup %}
